---
# ROLE LYNIS - AuditorÃ­a de seguridad del sistema
- name: "ğŸ“¦ Instalar dependencias para Lynis"
  apt:
    name:
      - curl
      - wget
      - gnupg
      - software-properties-common
      - jq
      - python3-pip
      - cron
    state: present
    update_cache: yes

- name: "ğŸ”‘ Agregar clave GPG de CISOfy (Lynis)"
  apt_key:
    url: "https://packages.cisofy.com/keys/cisofy-software-public.key"
    state: present

- name: "ğŸ“‚ Agregar repositorio de Lynis"
  apt_repository:
    repo: "deb https://packages.cisofy.com/community/lynis/deb/ stable main"
    state: present
    update_cache: yes

- name: "ğŸ“¥ Instalar Lynis"
  apt:
    name: lynis
    state: present
    update_cache: yes

- name: "ğŸ“ Crear directorios de Lynis"
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0750'
  loop:
    - "{{ lynis.config_dir }}"
    - "{{ lynis.data_dir }}"
    - "{{ lynis.logs_dir }}"
    - "{{ lynis.reports_dir }}"
    - "{{ lynis.data_dir }}/custom"
    - "/var/www/html/lynis-dashboard"

- name: "âš™ï¸ Configurar Lynis"
  template:
    src: lynis.conf.j2
    dest: "{{ lynis.config_dir }}/lynis.conf"
    owner: root
    group: root
    mode: '0644'

- name: "ğŸ”§ Crear perfil personalizado de auditorÃ­a"
  template:
    src: custom-profile.prf.j2
    dest: "{{ lynis.data_dir }}/custom/infra-made-easy.prf"
    owner: root
    group: root
    mode: '0644'

- name: "ğŸƒ Ejecutar auditorÃ­a inicial de Lynis"
  command: >
    lynis audit system
    --profile {{ lynis.data_dir }}/custom/infra-made-easy.prf
    --log-file {{ lynis.logs_dir }}/lynis-initial.log
    --report-file {{ lynis.reports_dir }}/lynis-initial.dat
  register: lynis_initial_audit
  changed_when: false
  ignore_errors: yes

- name: "ğŸ“Š Generar reporte JSON inicial"
  shell: |
    lynis show report --format json > {{ lynis.reports_dir }}/lynis-initial.json
  ignore_errors: yes

- name: "ğŸŒ Crear dashboard web simple para reportes"
  template:
    src: lynis-dashboard.html.j2
    dest: "/var/www/html/lynis-dashboard/index.html"
    owner: www-data
    group: www-data
    mode: '0644'

- name: "ğŸ“Š Crear script de mÃ©tricas para Prometheus"
  template:
    src: lynis-metrics.sh.j2
    dest: "{{ lynis.data_dir }}/lynis-metrics.sh"
    owner: root
    group: root
    mode: '0755'

- name: "ğŸ” Instalar simple exporter para mÃ©tricas"
  pip:
    name: prometheus_client
    state: present

- name: "ğŸ“ˆ Crear exporter de mÃ©tricas de seguridad"
  template:
    src: security-exporter.py.j2
    dest: "{{ lynis.data_dir }}/security-exporter.py"
    owner: root
    group: root
    mode: '0755'

- name: "ğŸ”§ Crear servicio systemd para security exporter"
  template:
    src: security-exporter.service.j2
    dest: "/etc/systemd/system/security-exporter.service"
    owner: root
    group: root
    mode: '0644'
  notify:
    - daemon reload
    - restart security-exporter

- name: "ğŸš€ Iniciar y habilitar security exporter"
  systemd:
    name: security-exporter
    state: started
    enabled: yes
    daemon_reload: yes

- name: "â° Configurar auditorÃ­as programadas"
  cron:
    name: "AuditorÃ­a rÃ¡pida diaria con Lynis"
    minute: "{{ lynis.schedule.cron_minute }}"
    hour: "{{ lynis.schedule.cron_hour }}"
    day: "{{ lynis.schedule.cron_day }}"
    job: "/usr/bin/lynis audit system --quick --quiet --log-file {{ lynis.logs_dir }}/lynis-daily-$(date +\\%Y\\%m\\%d).log"
    user: root
  when: lynis.schedule.enabled and lynis.schedule.daily_quick

- name: "ğŸ“… Configurar auditorÃ­a completa semanal"
  cron:
    name: "AuditorÃ­a completa semanal con Lynis"
    minute: "0"
    hour: "2"
    weekday: "0"
    job: "/usr/bin/lynis audit system --profile {{ lynis.data_dir }}/custom/infra-made-easy.prf --log-file {{ lynis.logs_dir }}/lynis-weekly-$(date +\\%Y\\%m\\%d).log && {{ lynis.data_dir }}/lynis-metrics.sh"
    user: root
  when: lynis.schedule.enabled and lynis.schedule.weekly_full

- name: "ğŸ”¥ Abrir puerto para mÃ©tricas"
  ufw:
    rule: allow
    port: "{{ lynis.web_dashboard.port }}"
  when: lynis.web_dashboard.enabled

- name: "ğŸ“‹ Obtener score de seguridad actual"
  shell: |
    if [ -f "{{ lynis.reports_dir }}/lynis-initial.dat" ]; then
      grep "hardening_index" {{ lynis.reports_dir }}/lynis-initial.dat | tail -1 | cut -d'=' -f2 || echo "0"
    else
      echo "0"
    fi
  register: current_security_score
  changed_when: false

- name: "ğŸ›¡ï¸ Crear script de hardening bÃ¡sico"
  template:
    src: basic-hardening.sh.j2
    dest: "{{ lynis.data_dir }}/basic-hardening.sh"
    owner: root
    group: root
    mode: '0750'

- name: "ğŸš€ Mostrar informaciÃ³n de Lynis"
  debug:
    msg:
      - "âœ… Lynis Security Audit configurado exitosamente"
      - ""
      - "ğŸ” AUDITORÃA DE SEGURIDAD:"
      - "   Score actual: {{ current_security_score.stdout | default('N/A') }}/100"
      - "   Score mÃ­nimo: {{ lynis.scoring.minimum_score }}/100"
      - "   Umbral warning: {{ lynis.scoring.warning_threshold }}/100"
      - ""
      - "ğŸ“Š DASHBOARDS Y REPORTES:"
      - "   Dashboard: http://{{ ansible_default_ipv4.address }}/lynis-dashboard/"
      - "   MÃ©tricas: http://{{ ansible_default_ipv4.address }}:{{ lynis.web_dashboard.port }}/metrics"
      - "   Reportes: {{ lynis.reports_dir }}/"
      - ""
      - "â° PROGRAMACIÃ“N:"
      - "   AuditorÃ­a diaria: {{ 'HABILITADA' if lynis.schedule.daily_quick else 'DESHABILITADA' }} ({{ lynis.schedule.cron_hour }}:{{ lynis.schedule.cron_minute }})"
      - "   AuditorÃ­a semanal: {{ 'HABILITADA' if lynis.schedule.weekly_full else 'DESHABILITADA' }} (Domingos 02:00)"
      - ""
      - "ğŸ”§ COMANDOS ÃšTILES:"
      - "   AuditorÃ­a manual: lynis audit system"
      - "   AuditorÃ­a rÃ¡pida: lynis audit system --quick"
      - "   Ver reporte: lynis show report"
      - "   Actualizar Lynis: lynis update info"
      - "   Hardening bÃ¡sico: {{ lynis.data_dir }}/basic-hardening.sh"
      - ""
      - "âš ï¸ IMPORTANTE:"
      - "   - Revisar reportes regularmente"
      - "   - Implementar recomendaciones gradualmente"
      - "   - Probar hardening en ambiente de desarrollo primero"
