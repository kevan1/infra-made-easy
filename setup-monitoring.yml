---
# EQUIPO MONITOREO - Stack Prometheus + Grafana (Ultra Modular)
- name: "ETAPA 2 - Configurar Stack de Monitoreo"
  hosts: monitoring_servers
  become: yes
  
  vars:
    # Variables especÃ­ficas para el stack de monitoring
    monitoring_stack_version: "2024.01"
    enable_alerting: false  # Para futuras implementaciones
    
  pre_tasks:
    - name: "ğŸ”„ Actualizar paquetes del sistema"
      apt:
        update_cache: yes
        upgrade: yes
        
    - name: "ğŸ“‹ Mostrar informaciÃ³n del servidor de monitoring"
      debug:
        msg:
          - "ğŸ–¥ï¸ Servidor: {{ inventory_hostname }}"
          - "ğŸŒ IP: {{ ansible_default_ipv4.address }}"
          - "ğŸ·ï¸ Nombre: {{ server_name | default('monitoring-server') }}"
          - "ğŸ‘¥ Equipo: {{ team_type | default('monitoring') }}"
        
  roles:
    - common           # âš™ï¸ ConfiguraciÃ³n base + usuarios
    - docker          # ğŸ³ Docker para contenedores (futuro uso)
    - node-exporter   # ğŸ“Š MÃ©tricas del sistema (instalar primero)
    - prometheus      # ğŸ” Sistema de mÃ©tricas y recolecciÃ³n
    - grafana         # ğŸ“ˆ Dashboards y visualizaciÃ³n
    
  post_tasks:
    - name: "â³ Esperar a que todos los servicios estÃ©n disponibles"
      wait_for:
        host: "{{ ansible_default_ipv4.address }}"
        port: "{{ item }}"
        delay: 5
        timeout: 60
      loop:
        - 9090  # Prometheus
        - 3000  # Grafana
        - 9100  # Node Exporter
      ignore_errors: yes
      
    - name: "ğŸ¯ Verificar estado de servicios"
      systemd:
        name: "{{ item }}"
        state: started
      loop:
        - prometheus
        - grafana-server
        - node-exporter
      register: service_status
      
    - name: "âœ… Mostrar resumen de instalaciÃ³n"
      debug:
        msg:
          - "ğŸš€ Stack de Monitoring configurado exitosamente!"
          - ""
          - "ğŸ“Š PROMETHEUS (MÃ©tricas):"
          - "   URL: http://{{ ansible_default_ipv4.address }}:9090"
          - "   Status: {{ 'ACTIVO' if service_status.results[0].status.ActiveState == 'active' else 'ERROR' }}"
          - ""
          - "ğŸ“ˆ GRAFANA (Dashboards):"
          - "   URL: http://{{ ansible_default_ipv4.address }}:3000"
          - "   Usuario: admin"
          - "   ContraseÃ±a: admin123 (âš ï¸ CAMBIAR EN PRODUCCIÃ“N)"
          - "   Status: {{ 'ACTIVO' if service_status.results[1].status.ActiveState == 'active' else 'ERROR' }}"
          - ""
          - "ğŸ–¥ï¸ NODE EXPORTER (MÃ©tricas Sistema):"
          - "   URL: http://{{ ansible_default_ipv4.address }}:9100/metrics"
          - "   Status: {{ 'ACTIVO' if service_status.results[2].status.ActiveState == 'active' else 'ERROR' }}"
          - ""
          - "ğŸ”— PRÃ“XIMOS PASOS:"
          - "   1. Cambiar contraseÃ±a de Grafana"
          - "   2. Configurar otros servidores con node-exporter"
          - "   3. Verificar dashboards automÃ¡ticos en Grafana"
          - "   4. Configurar alertas (opcional)"
