---
# ğŸ“ˆ ROLE MONITORING - ConfiguraciÃ³n de stack de monitoreo
- name: "ğŸ³ Instalar Docker y Docker Compose"
  apt:
    name:
      - docker.io
      - docker-compose
    state: present

- name: "ğŸš€ Configurar y iniciar Docker"
  systemd:
    name: docker
    state: started
    enabled: yes

- name: "ğŸ“ Crear directorio de monitoreo"
  file:
    path: /opt/monitoring
    state: directory
    owner: root
    group: docker
    mode: '0755'

- name: "âš™ï¸ Configurar Prometheus"
  template:
    src: prometheus.yml.j2
    dest: /opt/monitoring/prometheus.yml
    owner: root
    group: docker
    mode: '0644'
  notify: restart monitoring stack

- name: "ğŸ³ Configurar Docker Compose"
  template:
    src: docker-compose.yml.j2
    dest: /opt/monitoring/docker-compose.yml
    owner: root
    group: docker
    mode: '0644'
  notify: restart monitoring stack

- name: "ğŸš€ Levantar stack de monitoreo"
  docker_compose:
    project_src: /opt/monitoring
    state: present

- name: "ğŸ”“ Configurar firewall para monitoreo"
  ufw:
    rule: allow
    port: "{{ item }}"
  loop: "{{ firewall_ports }}"

- name: "ğŸ“Š Crear dashboard web del equipo"
  template:
    src: monitoring-dashboard.html.j2
    dest: /var/www/html/monitoring-dashboard.html
    owner: www-data
    group: www-data
    mode: '0644'

- name: "ğŸ“ˆ Mostrar informaciÃ³n de configuraciÃ³n"
  debug:
    msg:
      - "ğŸ‰ Â¡EQUIPO MONITOREO CONFIGURADO!"
      - "ğŸ“Š Prometheus: http://{{ ansible_default_ipv4.address }}:{{ prometheus_config.port }}"
      - "ğŸ“ˆ Grafana: http://{{ ansible_default_ipv4.address }}:{{ grafana_config.port }}"
      - "ğŸ”‘ Usuario Grafana: {{ grafana_config.admin_user }} / {{ grafana_config.admin_password }}"
