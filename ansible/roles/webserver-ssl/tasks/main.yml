---
# ğŸŒ ROLE WEBSERVER-SSL - ConfiguraciÃ³n de Nginx con SSL
- name: "ğŸ”§ Instalar Nginx y herramientas SSL"
  apt:
    name:
      - nginx
      - certbot
      - python3-certbot-nginx
      - nginx-extras
    state: present

- name: "ğŸ“Š Instalar Nginx Prometheus Exporter"
  get_url:
    url: "https://github.com/nginxinc/nginx-prometheus-exporter/releases/download/v0.11.0/nginx-prometheus-exporter_0.11.0_linux_amd64.tar.gz"
    dest: /tmp/nginx-exporter.tar.gz
  when: metrics_config.enable_nginx_exporter

- name: "ğŸ“Š Configurar Nginx Exporter"
  include_tasks: nginx_exporter.yml
  when: metrics_config.enable_nginx_exporter

- name: "âš™ï¸ Configurar Nginx optimizado"
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/sites-available/default
    owner: root
    group: root
    mode: '0644'
  notify: restart nginx

- name: "ğŸŒ Habilitar sitio"
  file:
    src: /etc/nginx/sites-available/default
    dest: /etc/nginx/sites-enabled/default
    state: link
  notify: restart nginx

- name: "ğŸ”¥ Crear pÃ¡gina web del equipo"
  template:
    src: index.html.j2
    dest: "{{ web_config.document_root }}/index.html"
    owner: www-data
    group: www-data
    mode: '0644'

- name: "ğŸš€ Iniciar y habilitar Nginx"
  systemd:
    name: nginx
    state: started
    enabled: yes

- name: "ğŸ”“ Configurar firewall para webserver"
  ufw:
    rule: allow
    port: "{{ item }}"
  loop: "{{ firewall_ports }}"

- name: "ğŸ”’ Configurar SSL (si dominios estÃ¡n configurados)"
  include_tasks: ssl_setup.yml
  when: domains is defined and domains | length > 0

- name: "ğŸŒ Mostrar informaciÃ³n de configuraciÃ³n"
  debug:
    msg:
      - "ğŸ‰ Â¡EQUIPO WEBSERVER + SSL CONFIGURADO!"
      - "ğŸŒ Servidor: http://{{ ansible_default_ipv4.address }}"
      - "ğŸ“Š MÃ©tricas: http://{{ ansible_default_ipv4.address }}:{{ metrics_config.nginx_exporter_port }}/metrics"
      - "ğŸ”’ Dominios configurados: {{ domains | join(', ') if domains is defined else 'Ninguno' }}"
