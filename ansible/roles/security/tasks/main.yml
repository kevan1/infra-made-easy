---
# ğŸ”’ ROLE SECURITY - ConfiguraciÃ³n de herramientas de seguridad
- name: "ğŸ”§ Instalar herramientas de seguridad"
  apt:
    name: "{{ security_tools }}"
    state: present

- name: "ğŸ›¡ï¸ Configurar Fail2ban"
  template:
    src: fail2ban-jail.local.j2
    dest: /etc/fail2ban/jail.local
    owner: root
    group: root
    mode: '0644'
  notify: restart fail2ban

- name: "ğŸš€ Iniciar y habilitar servicios de seguridad"
  systemd:
    name: "{{ item }}"
    state: started
    enabled: yes
  loop:
    - fail2ban
    - auditd

- name: "ğŸ“ Crear directorio de reportes"
  file:
    path: "{{ reporting_config.report_directory }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: "ğŸ” Crear script de auditorÃ­a"
  template:
    src: security-audit.sh.j2
    dest: /usr/local/bin/security-audit.sh
    owner: root
    group: root
    mode: '0755'

- name: "â° Programar auditorÃ­a automÃ¡tica"
  cron:
    name: "Security audit with Lynis"
    minute: "0"
    hour: "{{ lynis_config.audit_time.split(':')[0] }}"
    job: "/usr/local/bin/security-audit.sh"

- name: "ğŸ“Š Crear dashboard web de seguridad"
  template:
    src: security-dashboard.html.j2
    dest: /var/www/html/security-dashboard.html
    owner: www-data
    group: www-data
    mode: '0644'

- name: "ğŸš€ Ejecutar primera auditorÃ­a"
  command: /usr/local/bin/security-audit.sh
  async: 300
  poll: 0

- name: "ğŸ”“ Configurar firewall para mÃ©tricas"
  ufw:
    rule: allow
    port: "{{ item }}"
  loop: "{{ firewall_ports }}"

- name: "ğŸ”’ Mostrar informaciÃ³n de configuraciÃ³n"
  debug:
    msg:
      - "ğŸ‰ Â¡EQUIPO SEGURIDAD CONFIGURADO!"
      - "ğŸ” Dashboard: http://{{ ansible_default_ipv4.address }}/security-dashboard.html"
      - "ğŸ“Š Reportes en: {{ reporting_config.report_directory }}"
      - "â° AuditorÃ­a automÃ¡tica: {{ lynis_config.audit_frequency }} a las {{ lynis_config.audit_time }}"
