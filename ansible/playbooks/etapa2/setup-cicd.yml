---
# ğŸ”„ EQUIPO CI/CD - Setup Jenkins y automatizaciÃ³n
- name: "ğŸ”„ ETAPA 2 - Configurar Pipeline CI/CD"
  hosts: cicd_servers
  become: yes
  vars_files:
    - ../../../teams/cicd.yml

  tasks:
    - name: "ğŸ“¦ Actualizar sistema base"
      apt:
        update_cache: yes
        upgrade: yes

    - name: "â˜• Instalar Java para Jenkins"
      apt:
        name:
          - openjdk-11-jdk
          - curl
          - git
        state: present

    - name: "ğŸ³ Instalar Docker"
      apt:
        name:
          - docker.io
          - docker-compose
        state: present
      when: variables.enable_docker_in_docker | default(true)

    - name: "ğŸš€ Iniciar Docker"
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: "ğŸ‘¥ Crear usuarios del equipo"
      user:
        name: "{{ item }}"
        groups: sudo,docker
        shell: /bin/bash
        create_home: yes
      loop: "{{ members }}"

    - name: "ğŸ”‘ Configurar claves SSH"
      authorized_key:
        user: "{{ item }}"
        key: "{{ lookup('file', '../../../users/' + item + '/id_rsa.pub') }}"
      loop: "{{ members }}"
      ignore_errors: yes

    - name: "ğŸ”§ Descargar e instalar Jenkins"
      shell: |
        curl -fsSL https://pkg.jenkins.io/debian-stable/jenkins.io.key | sudo tee /usr/share/keyrings/jenkins-keyring.asc > /dev/null
        echo deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc] https://pkg.jenkins.io/debian-stable binary/ | sudo tee /etc/apt/sources.list.d/jenkins.list > /dev/null
        apt update
        apt install jenkins -y

    - name: "ğŸš€ Iniciar Jenkins"
      systemd:
        name: jenkins
        state: started
        enabled: yes

    - name: "ğŸ”“ Configurar firewall"
      ufw:
        rule: allow
        port: "8080"

    - name: "ğŸ“„ Crear script de deploy simple"
      copy:
        content: |
          #!/bin/bash
          # Script de deploy automÃ¡tico
          
          REPO_URL="${1:-https://github.com/curso-infra/sample-web-app.git}"
          TARGET_SERVERS="${2:-webserver_team_ips}"
          
          echo "ğŸš€ Iniciando deploy desde $REPO_URL"
          
          # Clonar repositorio
          rm -rf /tmp/deploy-repo
          git clone $REPO_URL /tmp/deploy-repo
          cd /tmp/deploy-repo
          
          # Ejecutar tests (si existen)
          if [ -f "package.json" ]; then
              npm test || echo "âš ï¸ Tests fallaron, pero continuando..."
          fi
          
          # Security scan (integraciÃ³n con equipo seguridad)
          echo "ğŸ” Security scan placeholder"
          
          # Deploy a servidores web
          echo "ğŸ“¦ Deploying to webservers..."
          # rsync -avz --delete ./ webserver1:/var/www/html/
          
          echo "âœ… Deploy completado"
        dest: /usr/local/bin/auto-deploy.sh
        mode: '0755'

    - name: "ğŸ“Š Crear dashboard de CI/CD"
      copy:
        content: |
          <!DOCTYPE html>
          <html>
          <head>
              <title>ğŸ”„ CI/CD Dashboard</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .header { background: #00b894; color: white; padding: 20px; border-radius: 8px; }
                  .pipeline { background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 8px; }
                  .status { padding: 5px 10px; border-radius: 5px; color: white; }
                  .success { background: #00b894; }
                  .running { background: #fdcb6e; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>ğŸ”„ CI/CD Pipeline Dashboard</h1>
                  <p>Equipo: CI/CD | Miembros: {{ members | join(', ') }}</p>
              </div>
              
              <div class="pipeline">
                  <h2>ğŸ“‹ Pipelines Activos</h2>
                  <div>
                      <h3>ğŸŒ Web App Deploy</h3>
                      <span class="status success">âœ… Ready</span>
                      <p>Deploy automÃ¡tico a servidores del Equipo Webserver</p>
                  </div>
              </div>
              
              <div class="pipeline">
                  <h2>ğŸ”— Integraciones</h2>
                  <ul>
                      <li>ğŸ“Š <strong>Monitoreo:</strong> MÃ©tricas de pipeline</li>
                      <li>ğŸ”’ <strong>Seguridad:</strong> Security scanning integrado</li>
                      <li>ğŸŒ <strong>Webserver:</strong> Deploy automÃ¡tico</li>
                      <li>âš™ï¸ <strong>Traefik:</strong> ActualizaciÃ³n de routing</li>
                  </ul>
              </div>
          </body>
          </html>
        dest: /var/www/html/cicd-dashboard.html

    - name: "ğŸ”„ Mostrar informaciÃ³n del equipo"
      debug:
        msg:
          - "ğŸ‰ Â¡EQUIPO CI/CD CONFIGURADO!"
          - "ğŸ‘¥ Miembros: {{ members | join(', ') }}"
          - "ğŸ”§ Jenkins: http://{{ ansible_default_ipv4.address }}:8080"
          - "ğŸ“Š Dashboard: http://{{ ansible_default_ipv4.address }}/cicd-dashboard.html"
          - "ğŸš€ Script de deploy: /usr/local/bin/auto-deploy.sh"
          - "ğŸ”— Listo para integrarse con otros equipos"
