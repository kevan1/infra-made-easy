---
# âš™ï¸ EQUIPO TRAEFIK + ACME - Load balancer y certificados automÃ¡ticos
- name: "âš™ï¸ ETAPA 2 - Configurar Traefik Load Balancer"
  hosts: traefik_servers
  become: yes
  vars_files:
    - ../../../teams/traefik-acme.yml

  tasks:
    - name: "ğŸ“¦ Actualizar sistema"
      apt:
        update_cache: yes
        upgrade: yes

    - name: "ğŸ³ Instalar Docker"
      apt:
        name:
          - docker.io
          - docker-compose
        state: present

    - name: "ğŸš€ Iniciar Docker"
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: "ğŸ‘¥ Crear usuarios del equipo"
      user:
        name: "{{ item }}"
        groups: sudo,docker
        shell: /bin/bash
        create_home: yes
      loop: "{{ members }}"

    - name: "ğŸ”‘ Configurar claves SSH"
      authorized_key:
        user: "{{ item }}"
        key: "{{ lookup('file', '../../../users/' + item + '/id_rsa.pub') }}"
      loop: "{{ members }}"
      ignore_errors: yes

    - name: "ğŸ“ Crear directorio de Traefik"
      file:
        path: /opt/traefik
        state: directory
        owner: root
        group: docker
        mode: '0755'

    - name: "âš™ï¸ Configurar Traefik"
      copy:
        content: |
          # ConfiguraciÃ³n principal de Traefik
          global:
            checkNewVersion: false
            sendAnonymousUsage: false
            
          api:
            dashboard: true
            insecure: true  # Solo para desarrollo
            
          entryPoints:
            web:
              address: ":80"
            websecure:
              address: ":443"
              
          providers:
            docker:
              exposedByDefault: false
              
          certificatesResolvers:
            {{ variables.certificate_resolver }}:
              acme:
                email: {{ variables.acme_email }}
                storage: /acme.json
                httpChallenge:
                  entryPoint: web
                  
          log:
            level: {{ variables.log_level }}
            
          accessLog: {}
        dest: /opt/traefik/traefik.yml

    - name: "ğŸ³ Crear Docker Compose para Traefik"
      copy:
        content: |
          version: '3.8'
          services:
            traefik:
              image: traefik:v2.10
              container_name: traefik
              ports:
                - "80:80"
                - "443:443"
                - "8080:8080"  # Dashboard
              volumes:
                - /var/run/docker.sock:/var/run/docker.sock:ro
                - ./traefik.yml:/etc/traefik/traefik.yml:ro
                - ./acme.json:/acme.json
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.dashboard.rule=Host(`traefik.curso-infra.com`)"
                - "traefik.http.routers.dashboard.tls.certresolver={{ variables.certificate_resolver }}"
              restart: unless-stopped
              
            # Servicio de ejemplo para demostrar load balancing
            whoami:
              image: traefik/whoami
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.whoami.rule=Host(`whoami.curso-infra.com`)"
                - "traefik.http.routers.whoami.tls.certresolver={{ variables.certificate_resolver }}"
        dest: /opt/traefik/docker-compose.yml

    - name: "ğŸ” Crear archivo ACME"
      file:
        path: /opt/traefik/acme.json
        state: touch
        owner: root
        group: root
        mode: '0600'

    - name: "ğŸš€ Levantar Traefik"
      docker_compose:
        project_src: /opt/traefik
        state: present

    - name: "ğŸ”“ Configurar firewall"
      ufw:
        rule: allow
        port: "{{ item }}"
      loop: "{{ ports }}"

    - name: "ğŸ“Š Crear dashboard de Traefik"
      copy:
        content: |
          <!DOCTYPE html>
          <html>
          <head>
              <title>âš™ï¸ Traefik Load Balancer</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .header { background: #6c5ce7; color: white; padding: 20px; border-radius: 8px; }
                  .service { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; }
                  .status { padding: 5px 10px; border-radius: 5px; color: white; background: #00b894; }
              </style>
          </head>
          <body>
              <div class="header">
                  <h1>âš™ï¸ Traefik Load Balancer</h1>
                  <p>Equipo: Traefik + ACME | Miembros: {{ members | join(', ') }}</p>
              </div>
              
              <div class="service">
                  <h2>ğŸ”— Servicios Balanceados</h2>
                  <div>
                      <h3>ğŸŒ Webservers</h3>
                      <span class="status">âœ… Active</span>
                      <p>Load balancing a servidores del Equipo Webserver + SSL</p>
                  </div>
                  <div>
                      <h3>ğŸ“Š Monitoring</h3>
                      <span class="status">âœ… Active</span>
                      <p>Grafana dashboard accesible via Traefik</p>
                  </div>
              </div>
              
              <div class="service">
                  <h2>ğŸ”’ Certificados ACME</h2>
                  <p>Certificados automÃ¡ticos para: {{ acme_domains | join(', ') }}</p>
              </div>
          </body>
          </html>
        dest: /var/www/html/traefik-dashboard.html

    - name: "âš™ï¸ Mostrar informaciÃ³n del equipo"
      debug:
        msg:
          - "ğŸ‰ Â¡EQUIPO TRAEFIK + ACME CONFIGURADO!"
          - "ğŸ‘¥ Miembros: {{ members | join(', ') }}"
          - "âš™ï¸ Dashboard: http://{{ ansible_default_ipv4.address }}:8080"
          - "ğŸŒ Proxy: http://{{ ansible_default_ipv4.address }}"
          - "ğŸ”’ ACME configurado para: {{ acme_domains | join(', ') }}"
          - "ğŸ”— Listo para balancear servicios de otros equipos"
